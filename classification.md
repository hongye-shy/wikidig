# 处理方法

## 数据情况

目前处理的分类，需要从“Main_topic_classifications”开始，如果从绝对的根节点
“Contents”开始，则由于包含了大量的管理类节点（如Help），导致信息混乱。“Main
topic classification"下，共包含了23个分类，如下所示：

+----------|----------|------------------------+
| id | pageId | name |
+----------|----------|------------------------+
|   690747 |   690747 | Mathematics            |
|   691008 |   691008 | People                 |
|   691810 |   691810 | Philosophy             |
|   691928 |   691928 | Law                    |
|   692694 |   692694 | Religion               |
|   693555 |   693555 | History                |
|   693708 |   693708 | Sports                 |
|   693800 |   693800 | Geography              |
|   694861 |   694861 | Culture                |
|   695027 |   695027 | Politics               |
|   696603 |   696603 | Nature                 |
|   696763 |   696763 | Education              |
|   722196 |   722196 | Reference              |
|   751381 |   751381 | Health                 |
|  1004110 |  1004110 | Humanities             |
|  1633936 |  1633936 | Society                |
|  2389032 |  2389032 | Life                   |
|  2766046 |  2766046 | Events                 |
|  3260154 |  3260154 | World                  |
|  4892515 |  4892515 | Arts                   |
|  8017451 |  8017451 | Language               |
| 47642171 | 47642171 | Science_and_technology |
| 48005914 | 48005914 | Universe               |
+----------|----------|------------------------+


## 数据的变换

原始数据（https://dumps.wikimedia.org/enwiki/20180801/)下载之后，利用JWPL进行第
一遍清洗，清洗结果导入MySQL数据库中。

然后利用如下方式，构建分类三角形抽取所需要的数据集：

令每个分类节点拥有如下属性：深度（距离main topic的最短路径长度）、出链和入链数量、
父节点集合（一个节点可以隶属于多个父节点）、子节点集合、权重（暂时用出入链数量之
和作为权重）

首先采用层次遍历方式，将23个一级分类轧入队列。只要队列不空，循环处理，每次从队列
中取出一个节点n：

(1) 如果n之前已经处理过（已经保存），并且与之前的深度不同，则更新旧节点的父信息，
相当于节点n有多条路径可以到达。此时跳过后续步骤并继续下一轮循环。如果未处理过，
则继续后续步骤。

(2) 从MySQL相应表中读取节点n的子类集合，删除符合特定模式或者深度大于5的节点，所
得到的子集作为n的子类集合，并压入队列。

(3) 记录n的属性信息到NoSQL数据库RocksDB中，方便在其它计算机上复用处理结果。保存
时主键为类别的id，值为属性信息，包括id、深度、出入链数量、父节点集合和子节点集合。
子节点集合在保存时，为方便后续的抽样计算，采用如下方式保存[(累计权重：子类
ID1),(累计权重：子类ID2)...]，例如[(3:123), (8, 125)...]，表示子类123的权重为3，
子类125的权重为5，和上一个的累加结果为8。

(4) 单独在RocksDB中记录节点id和名称之间的关系，方便按名查找。

通过这种方式，我们利用RocksDB数据库，背后以Key－Value存储方式，在逻辑上建立了一
棵有向图，保留了维基百科分类体系的前5层信息。

## 三角形的生成

我们将三角形的抽取分成两个步骤：

(1) 挑选一个节点R作为三角形的根。(2) 从R的子类中挑选两个节点A、B，形成三元组
（R,A, B)作为一次抽样结果。

### 根的选择

目前根的选择采用了按节点权重比例进行分配的方案。

令T代表前4层节点的权重之和，并假设要抽取的三角形数量为M，节点n的权重为w_n，则节
点n被抽到的数量为：max(1, w_n*M/T)，即每个节点按节点权重等比例抽取，并且至少要被
抽中一次。


### 三角形底部节点的选择

取出根节点的所有子类集合，如果子类只有一个，则直接返回（相当于子类没有分类，那么
该子类并没有带来区分度，所以舍弃）。否则，以不放回抽样的方式，按照子类的权重比例
挑选两个子节点作为结果。与根节点一起形成所选择的三角形。
